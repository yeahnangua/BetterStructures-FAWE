# Terra 兼容自然生成修复设计

Date: 2026-02-24

## 背景与问题

当前自然生成链路在 Terra 场景下存在多处前后语义不一致，核心问题是：

1. 区块在“扫描结束”后即被标记为 processed，而不是“成功放置后”再标记。
2. 扫描失败后区块永久跳过，导致 Terra 慢生成场景中经常错过有效时机。
3. 去重窗口与延迟扫描窗口不一致，可能出现重复排队。
4. 一些 Terra 兼容相关配置语义与实际行为不完全一致。

这会造成用户可通过 `/bs place` 手动放置，但自然生成稳定性偏低。

## 目标

1. 全局改为“仅成功放置后标记 processed”。
2. 保持现有结构分布规则（`distance*`、`maxOffset*`）不变。
3. 修复扫描调度生命周期中的重复排队窗口问题。
4. 补齐可观测性，能从日志判断失败点（扫描失败/粘贴失败/成功标记）。

## 非目标

1. 不改动结构评分算法本身（Topology/TerrainAdequacy 的评分公式不在本次重写范围）。
2. 不引入大型状态机框架或跨模块重构。
3. 不更改已有配置键名，避免用户迁移成本。

## 方案选择

已评估三种方案：

1. 增量重构（方案 A，采用）
2. 完整状态机重构（方案 B）
3. 配置驱动修补（方案 C）

采用方案 A，原因是可在可控改动面内解决核心行为缺陷，同时保持兼容性和交付速度。

## 架构设计

### 1) 标记语义重定义

`chunk_processed` 语义改为：**该区块已成功生成过结构**。  
不再表示“这个区块被扫描过”。

### 2) 责任边界

1. `NewChunkLoadEvent`：仅负责触发、重试调度、生命周期去重。
2. 扫描器（surface/sky/underground/liquid/dungeon）：负责尝试放置并返回“是否成功发起/完成放置”信号。
3. 粘贴完成回调：作为最终成功信号落点，统一触发 processed 标记。

### 3) 去重生命周期

`loadingChunks` 不再固定 20 tick 释放，而是绑定任务生命周期：

1. 扫描重试链路结束后释放；
2. 或在明确终态（成功标记 / 扫描失败终止）后释放；
3. 防止延迟扫描期间重复入队同一 chunk。

## 数据流与状态转移

定义最小状态语义（无需引入重型状态机框架）：

1. `SKIP_PROCESSED`：已成功处理过，跳过。
2. `SCAN_FAILED`：本轮未找到可放置点或未通过条件，不标记。
3. `PASTE_FAILED`：进入粘贴但失败，不标记。
4. `PASTE_SUCCESS`：粘贴完成，写 processed。

流程：

1. `ChunkLoadEvent` 触发 -> 校验世界与去重状态；
2. 延迟/重试扫描；
3. 扫描器汇总结果；
4. 若粘贴完成成功 -> 写 processed；
5. 释放去重占位。

## 兼容策略

1. 全局生效“仅成功才标记”。
2. `terraCompatibility.enabled` 继续作为扫描延迟下限策略开关，不影响新标记语义。
3. `distance*` 与 `maxOffset*` 保持不变，结构空间分布不发生策略性变化。

## 错误处理与可观测性

新增/统一调试日志事件（建议 DEBUG）：

1. `SKIP_PROCESSED`：已处理区块跳过；
2. `SCAN_FAILED`：扫描失败（可附简短原因码）；
3. `PASTE_FAILED`：粘贴失败（异常摘要）；
4. `PASTE_SUCCESS_MARKED`：成功并写 processed。

目标是让线上排查不再依赖猜测。

## 测试与验收

### 测试维度

1. 逻辑层：
   - 扫描失败不写 processed；
   - 粘贴成功才写 processed；
   - 已 processed 区块后续跳过。
2. 集成层：
   - `terraCompatibility=false/true` 两组验证；
   - 新区块自然跑图验证；
   - 重启后行为一致性验证。
3. 回归层：
   - `/bs place` 行为不变；
   - Overworld/Nether 自然生成不退化。

### 验收标准

1. 不再出现“扫描失败后永久跳过该 chunk”的错误语义。
2. 成功放置后仍保持幂等，不会在后续自然流程重复生成。
3. Terra 场景下自然生成成功率相对当前版本显著提升（定性可观测）。

## 受影响文件（设计级）

1. `listeners/NewChunkLoadEvent.java`
2. `buildingfitter/FitAnything.java`
3. `worldedit/Schematic.java`
4. 可能涉及各 `Fit*` 生成器返回值签名与汇总逻辑
5. 可选：新增轻量结果类型（例如 `PlacementResult`）

## 风险与缓解

1. 风险：失败区块可重试后，扫描量上升。
   缓解：完善生命周期去重与日志观察，必要时再加节流配置。
2. 风险：多扫描器并发导致成功信号竞争。
   缓解：以“任一成功即 processed=true”为准，使用线程安全汇总。
3. 风险：dungeon 主线程分支与异步扫描分支结果汇总复杂。
   缓解：统一结果聚合接口，避免隐式 side-effect。
